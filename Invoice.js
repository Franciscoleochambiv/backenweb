           const fs = require("fs");
            var f = new Date();
            horaA=f.getFullYear()+"-"+(f.getMonth() +1)+"-"+f.getDate();
              var rucemisor="10444864589";

                var item=0;
                var proveedor="lolo";
                var razonemisor="CHAQUILLA SONCCO VIANEY";
                var provincia="AREQUIPA";
                var ciudad="AREQUIPA";
                var distrito="MIRAFLORES";
                var diremisor="PUEBLO JOVEN JUAN XXIII MZNA O LTE 4";

                var plantilla3 ='</Invoice>';


                //20455968268-01-F001-2089.zip

                
                


               

function Invoice(data,res) {
    var nombrearchivo=rucemisor+"-"+data.tipo_de_comprobante+"-"+data.serie+"-"+data.numero;
    var archivosinfirma=nombrearchivo+"sf"+".xml";
                var firmado=nombrearchivo+".xml";
                var firmadozip=nombrearchivo+".zip";
            




                var plantilla='<?xml version="1.0" encoding="UTF-8"?>'+
                '<Invoice xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2" xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" xmlns:ccts="urn:un:unece:uncefact:documentation:2" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2" xmlns:qdt="urn:oasis:names:specification:ubl:schema:xsd:QualifiedDatatypes-2" xmlns:udt="urn:un:unece:uncefact:data:specification:UnqualifiedDataTypesSchemaModule:2" xmlns="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2">'+
                '<ext:UBLExtensions>'+
                    '<ext:UBLExtension>'+
                    '<ext:ExtensionContent>'+ 
                    '<Signature xmlns="http://www.w3.org/2000/09/xmldsig#">'+
                        '<SignedInfo>'+
                            '<CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>'+
                            '<SignatureMethod Algorithm="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"/>'+
                            '<Reference URI="">'+
                            '<Transforms>'+
                            '<Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature" />'+
                            '</Transforms>'+
                            '<DigestMethod Algorithm="http://www.w3.org/2001/04/xmlenc#sha256"/>'+
                            '<DigestValue></DigestValue>'+
                            '</Reference>'+
                        '</SignedInfo>'+
                        '<SignatureValue/>'+
                        '<KeyInfo>'+
                        '<X509Data>'+
                        '<X509SubjectName/>'+
                        '<X509Certificate/>'+
                        '</X509Data>'+
                        '</KeyInfo>'+
                    '</Signature>'+
                    '</ext:ExtensionContent>'+
                    '</ext:UBLExtension>'+
                '</ext:UBLExtensions>'+
                '<cbc:UBLVersionID>2.1</cbc:UBLVersionID>'+
                '<cbc:CustomizationID>2.0</cbc:CustomizationID>'+
                '<cbc:ID>'+data.serie+"-"+data.numero+'</cbc:ID>'+
                '<cbc:IssueDate>'+data.fecha_de_emision+'</cbc:IssueDate>'+
                '<cbc:DueDate>'+data.fecha_de_emision+'</cbc:DueDate>'+
                '<cbc:InvoiceTypeCode listID="0101" listAgencyName="PE:SUNAT" listName="Tipo de Documento" listURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo01" name="Tipo de Operacion" listSchemeURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo51">'+data.tipo_de_comprobante+'</cbc:InvoiceTypeCode>'+
                '<cbc:Note languageLocaleID="1000">'+data.total_letras+'</cbc:Note>'+
                '<cbc:DocumentCurrencyCode listID="ISO 4217 Alpha" listAgencyName="United Nations Economic Commission for Europe" listName="Currency">PEN</cbc:DocumentCurrencyCode>'+
                '<cac:Signature>'+
                    '<cbc:ID>'+rucemisor+'</cbc:ID>'+
                    '<cbc:Note>'+proveedor+'</cbc:Note>'+
                    '<cac:SignatoryParty>'+
                    '<cac:PartyIdentification>'+
                        '<cbc:ID>'+rucemisor+'</cbc:ID>'+
                    '</cac:PartyIdentification>'+
                    '<cac:PartyName>'+
                        '<cbc:Name>'+razonemisor+'</cbc:Name>'+
                    '</cac:PartyName>'+
                    '</cac:SignatoryParty>'+
                    '<cac:DigitalSignatureAttachment>'+
                    '<cac:ExternalReference>'+
                        '<cbc:URI>'+rucemisor+'</cbc:URI>'+
                    '</cac:ExternalReference>'+
                    '</cac:DigitalSignatureAttachment>'+
                '</cac:Signature>'+
                '<cac:AccountingSupplierParty>'+
                    '<cac:Party>'+
                    '<cac:PartyIdentification>'+
                        '<cbc:ID schemeID="6" schemeName="Documento de Identidad" schemeAgencyName="PE:SUNAT" schemeURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06">'+rucemisor+'</cbc:ID>'+
                    '</cac:PartyIdentification>'+
                    '<cac:PartyName>'+
                    '<cbc:Name>'+razonemisor+'</cbc:Name>'+
                    '</cac:PartyName>'+
                    '<cac:PartyLegalEntity>'+
                        '<cbc:RegistrationName>'+razonemisor+'</cbc:RegistrationName>'+
                        '<cac:RegistrationAddress>'+
                        '<cbc:ID schemeName="Ubigeos" schemeAgencyName="PE:INEI">040110</cbc:ID>'+
                        '<cbc:AddressTypeCode listAgencyName="PE:SUNAT" listName="Establecimientos anexos">0000</cbc:AddressTypeCode>'+
                        '<cbc:CityName>'+provincia+'</cbc:CityName>'+
                        '<cbc:CountrySubentity>'+ciudad+'</cbc:CountrySubentity>'+
                        '<cbc:District>'+distrito+'</cbc:District>'+
                        '<cac:AddressLine>'+
                            '<cbc:Line>'+diremisor+'</cbc:Line>'+
                        '</cac:AddressLine>'+
                        '<cac:Country>'+
                            '<cbc:IdentificationCode listID="ISO 3166-1" listAgencyName="United Nations Economic Commission for Europe" listName="Country">PE</cbc:IdentificationCode>'+
                        '</cac:Country>'+
                        '</cac:RegistrationAddress>'+
                    '</cac:PartyLegalEntity>'+
                    '</cac:Party>'+
                '</cac:AccountingSupplierParty>'+
                '<cac:AccountingCustomerParty>'+
                    '<cac:Party>'+
                    '<cac:PartyIdentification>'+
                        '<cbc:ID schemeID="6" schemeName="Documento de Identidad" schemeAgencyName="PE:SUNAT" schemeURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo06">'+data.cliente_numero_de_documento+'</cbc:ID>'+
                    '</cac:PartyIdentification>'+
                    '<cac:PartyLegalEntity>'+
                        '<cbc:RegistrationName>'+data.cliente_denominacion+'</cbc:RegistrationName>'+
                    '</cac:PartyLegalEntity>'+
                    '</cac:Party>'+
                '</cac:AccountingCustomerParty>'+
                 '<cac:PaymentTerms>'+
                 '<cbc:ID>FormaPago</cbc:ID>'+
                '<cbc:PaymentMeansID>Contado</cbc:PaymentMeansID>'+
                '</cac:PaymentTerms>'+
                '<cac:TaxTotal>'+
                    '<cbc:TaxAmount currencyID="PEN">'+data.total_igv+'</cbc:TaxAmount>'+
                    '<cac:TaxSubtotal>'+
                    '<cbc:TaxableAmount currencyID="PEN">'+data.total_gravada+'</cbc:TaxableAmount>'+
                    '<cbc:TaxAmount currencyID="PEN">'+data.total_igv+'</cbc:TaxAmount>'+
                    '<cac:TaxCategory>'+
                        '<cac:TaxScheme>'+
                        '<cbc:ID schemeName="Codigo de tributos" schemeAgencyName="PE:SUNAT" schemeURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05">1000</cbc:ID>'+
                        '<cbc:Name>IGV</cbc:Name>'+
                        '<cbc:TaxTypeCode>VAT</cbc:TaxTypeCode>'+
                        '</cac:TaxScheme>'+
                    '</cac:TaxCategory>'+
                    '</cac:TaxSubtotal>'+
                '</cac:TaxTotal>'+
                '<cac:LegalMonetaryTotal>'+
                    '<cbc:LineExtensionAmount currencyID="PEN">'+data.total_gravada+'</cbc:LineExtensionAmount>'+
                    '<cbc:TaxInclusiveAmount currencyID="PEN">'+data.total+'</cbc:TaxInclusiveAmount>'+
                    '<cbc:AllowanceTotalAmount currencyID="PEN">0.00</cbc:AllowanceTotalAmount>'+
                    '<cbc:ChargeTotalAmount currencyID="PEN">0.00</cbc:ChargeTotalAmount>'+
                    '<cbc:PrepaidAmount currencyID="PEN">0.00</cbc:PrepaidAmount>'+
                    '<cbc:PayableAmount currencyID="PEN">'+data.total+'</cbc:PayableAmount>'+
                '</cac:LegalMonetaryTotal>';

                var data=data.items;     

                fs.writeFileSync(archivosinfirma, plantilla);

                
                escribeitem(data);

                 

  

            }     //cioerra invboice





            function escribeitem(datos){

            console.log(datos[0].unit_price)
            let data=datos;
            var unidad;

           let item2=0;
                for(var atr in datos){

                    unidad=datos[atr].unidad_de_medida;

                    item=item+1;
                    item2=item2+1
    
    
                    var plantilla2=
                    '<cac:InvoiceLine>'+
                    '<cbc:ID>'+item.toString()+'</cbc:ID>'+
                    '<cbc:InvoicedQuantity unitCode="'+unidad+'" unitCodeListID="UN/ECE rec 20" unitCodeListAgencyName="United Nations Economic Commission for Europe">'+data.items[atr].quantity+'</cbc:InvoicedQuantity>'+
                    '<cbc:LineExtensionAmount currencyID="PEN">'+datos[atr].item_tax+'</cbc:LineExtensionAmount>'+
                    '<cac:PricingReference>'+
                        '<cac:AlternativeConditionPrice>'+
                        '<cbc:PriceAmount currencyID="PEN">'+datos[atr].unit_price+'</cbc:PriceAmount>'+
                        '<cbc:PriceTypeCode listAgencyName="PE:SUNAT" listName="Tipo de Precio" listURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo16">01</cbc:PriceTypeCode>'+
                        '</cac:AlternativeConditionPrice>'+
                    '</cac:PricingReference>'+
                    '<cac:TaxTotal>'+
                        '<cbc:TaxAmount currencyID="PEN">'+datos[atr].tax+'</cbc:TaxAmount>'+
                        '<cac:TaxSubtotal>'+
                        '<cbc:TaxableAmount currencyID="PEN">'+datos.tems[atr].item_tax+'</cbc:TaxableAmount>'+
                        '<cbc:TaxAmount currencyID="PEN">'+datos.items[atr].tax+'</cbc:TaxAmount>'+
                        '<cac:TaxCategory>'+
                            '<cbc:Percent>'+"18"+'</cbc:Percent>'+
                            '<cbc:TaxExemptionReasonCode listAgencyName="PE:SUNAT" listName="Afectacion del IGV" listURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo07">10</cbc:TaxExemptionReasonCode>'+
                            '<cac:TaxScheme>'+
                            '<cbc:ID schemeName="Codigo de tributos" schemeAgencyName="PE:SUNAT" schemeURI="urn:pe:gob:sunat:cpe:see:gem:catalogos:catalogo05">1000</cbc:ID>'+
                            '<cbc:Name>IGV</cbc:Name>'+
                            '<cbc:TaxTypeCode>VAT</cbc:TaxTypeCode>'+
                            '</cac:TaxScheme>'+
                        '</cac:TaxCategory>'+
                        '</cac:TaxSubtotal>'+
                    '</cac:TaxTotal>'+
                    '<cac:Item>'+
                        '<cbc:Description>'+datos[atr].product_name+'</cbc:Description>'+
                    '</cac:Item>'+
                    '<cac:Price>'+
                        '<cbc:PriceAmount currencyID="PEN">'+datos[atr].real_unit_price+'</cbc:PriceAmount>'+
                    '</cac:Price>'+
                    '</cac:InvoiceLine>';

                    
                    fs.appendFile(archivosinfirma, plantilla2, (err) => {
                    if (err) throw err;
                    //console.log('The "data to append" was appended to file!');
                    });
                    }
                }































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































                



                    function firmado1(){


                        fs.appendFile(archivosinfirma, plantilla3, (err) => {
                            if (err) throw err;
                           
            
                            var exec = require('child_process').exec, child;          
                            var orden2=' xmlsec1 --sign --privkey-pem private_key.pem,certificado.pem --output '+firmado +' '+ archivosinfirma ;
                            var orden3 = " && zip "+ firmadozip+ " "+ firmado;
            
                            console.log(orden2);
            
                            child =   exec(orden2+orden3, 
                          
                            function (error, stdout, stderr) {
                              
                                 console.log(stdout);
                                 console.log("firmando completado");    
                                 console.log("enviamos el archivo");
            
                                /*
                                 var data = fs.readFileSync(firmadozip,{
                                    encoding:"base64"
                                },(err, res) => {
                                    if(err){
                                        console.error(err)
                                    }
                                  }
                                
                                );
                                  */
            
                                console.log("he leido  el archivo firmado.,zip");                             
                                //var resultado= "R-"+firmadozip; 
                                //resulcli=resultado;
                                }
                            )
                        }
                        );
                    }
                     
    
         



  module.exports = {
    Invoice
  };
  